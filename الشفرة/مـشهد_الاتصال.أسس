@منفذ_بياني["POST", "/api/contact"]
دالة اتصل_بي(اتصال:مؤشر[بـننف.اتـصال]) {
    عرف صوان: مصفوفة[مـحرف، 2048]؛
    عرف حجم_البيانات: صحيح = بـننف.اقرأ(اتصال، صوان~مؤشر، صوان~حجم)؛
    عرف نص_جيسون: نـص = نـص(صوان~مؤشر، حجم_البيانات)؛
    عرف جيسون: جـيسون(نص_جيسون)؛
    عرف البريد_الإلكتروني: نـص = جيسون.هات_نص("email")؛
    عرف الاسم: نـص = جيسون.هات_نص("name")؛
    عرف العنوان: نـص = جيسون.هات_نص("title")؛
    عرف المتن: نـص = جيسون.هات_نص("body")؛
    عرف رمز_كابجا: نـص = جيسون.هات_نص("captchatoken")؛
    إذا ليس ريـكابجا.تحقق(إعـدادات.مفتاح_خادم_كابجا، رمز_كابجا) {
        بـننف.اطبع(اتصال, "HTTP/1.1 422 error\r\n");
        بـننف.اطبع(اتصال, "Content-Type: text/plain\r\n");
        بـننف.اطبع(اتصال, "Cache-Control: no-cache\r\n");
        بـننف.اطبع(اتصال, "Location: %s\r\n", "/profile");
        بـننف.اطبع(اتصال, "Content-Length: %d\r\n\r\n", 0);
        بـننف.اطبع(اتصال, "");
    } وإلا إذا أرسل_بريدًا_إلكترونيا(البريد_الإلكتروني، الاسم، العنوان، المتن) {
        بـننف.اطبع(اتصال, "HTTP/1.1 200 error\r\n");
        بـننف.اطبع(اتصال, "Content-Type: text/plain\r\n");
        بـننف.اطبع(اتصال, "Cache-Control: no-cache\r\n");
        بـننف.اطبع(اتصال, "Location: %s\r\n", "/profile");
        بـننف.اطبع(اتصال, "Content-Length: %d\r\n\r\n", 0);
        بـننف.اطبع(اتصال, "");
    } وإلا {
        بـننف.اطبع(اتصال, "HTTP/1.1 500 error\r\n");
        بـننف.اطبع(اتصال, "Content-Type: text/plain\r\n");
        بـننف.اطبع(اتصال, "Cache-Control: no-cache\r\n");
        بـننف.اطبع(اتصال, "Location: %s\r\n", "/profile");
        بـننف.اطبع(اتصال, "Content-Length: %d\r\n\r\n", 0);
        بـننف.اطبع(اتصال, "");
    }
}

صنف مـشهد_الاتصال {
    @حقنة عرف مشهد_أيقوني: مـشهد_أيقوني؛
    عرف الإشعار: سـندنا[كـتابة]؛
    عرف الاسم: سـندنا[مـدخل]؛
    عرف البريد_الإلكتروني: سـندنا[مـدخل]؛
    عرف العنوان: سـندنا[مـدخل]؛
    عرف المتن: سـندنا[مـدخل_نص]؛
    عرف كابجا: سـندنا[ريـكابجا.كـابجا]؛
    عرف رمز_كابجا: نـص؛

    عملية هذا~هيئ() {
        عرف الكائن: سند[هذا_الصنف](هذا)؛
        هذا.المشهد = صـندوق().{
            الطراز.{
                ملء_السطر = "start"؛
                المحاذاة = "center"؛
                العرض = "calc(100vw - 30pt)"؛
                الطول = "calc(100% - 60pt)"؛
                الإظهار = "flex"؛
                النسق = "column"؛
                الهامش = ربـاعية(5)؛
            }؛
            الطراز(">مدخل").{
                العرض = "100%"؛
                نصف_قطر_الإطار = ربـاعية(5)؛
                الهامش = ربـاعية(5)؛
            }؛
            الطراز(">مدخل_نص").{
                العرض = "100%"؛
                المرونة = "1"؛
                نصف_قطر_الإطار = ربـاعية(5)؛
                الهامش = ربـاعية(5)؛
            }؛
            الطراز(">إرسال").{
                العرض = "50pt"؛
                المؤشر = "pointer"؛
                الهامش = ربـاعية(5)؛
            }؛
            الطراز(">إشعار_خطأ").{
                العرض = "100%"؛
                لون_الخط = لـون("800")؛
            }؛
            الطراز(">إشعار_نجاح").{
                العرض = "100%"؛
                لون_الخط = لـون("080")؛
            }؛
            أضف_فروع({
                كـتابة().{
                    الكائن.الإشعار = هذا؛
                }،
                مـدخل().{
                    الكائن.الاسم = هذا؛
                    قيمة_وصفية = نـص("الاسم")؛
                    اسم_الفئة = نـص("مدخل")؛
                },
                مـدخل().{
                    الكائن.البريد_الإلكتروني = هذا؛
                    قيمة_وصفية = نـص("البريد الإلكتروني")؛
                    اسم_الفئة = نـص("مدخل")؛
                },
                مـدخل().{
                    الكائن.العنوان = هذا؛
                    قيمة_وصفية = نـص("العنوان")؛
                    اسم_الفئة = نـص("مدخل")؛
                },
                مـدخل_نص().{
                    الكائن.المتن = هذا؛
                    اسم_الفئة = نـص("مدخل_نص")؛
                },
                ريـكابجا.كـابجا(نـص(سلسلة_محارف_من_متغير[إعـدادات.مفتاح_واجهة_كابجا])).{
                    الكائن.كابجا = هذا؛
                }،
                صـورة().{
                    الرابط = نـص("/الموارد/إرسال.svg")؛
                    اسم_الفئة = نـص("إرسال")؛
                    عند_الضغط.اربط(مغلفة (سند[ودجـة]، سند[صـحيح]) {
                        الكائن.رمز_كابجا = الكائن.كابجا.هات_الإجابة()؛
                        الكائن.أرسل()؛
                    })؛
                }،
            })؛
        }؛
    }

    عرف _إرسال_: "POST"؛
    عرف _المسار_: "/api/contact"؛
    عرف _ترويسة_صنف_بيانات_نصي_: "Content-Type: application/json"؛

    عملية هذا.أرسل() {
        عرف الاسم: نـص = هذا.الاسم.هات_النص().شذب()؛
        عرف البريد_الإلكتروني: نـص = هذا.البريد_الإلكتروني.هات_النص().شذب()؛
        عرف العنوان: نـص = هذا.العنوان.هات_النص().شذب()؛
        عرف المتن: نـص = هذا.المتن.هات_النص().شذب()؛
        إذا الاسم == "" أو البريد_الإلكتروني == "" أو العنوان == "" أو المتن == "" {
            هذا.الإشعار.النص = نـص("يُرجى إدخال جميع الحقول")؛
            هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
            ارجع؛
        }

        إذا طابق_نمطا(البريد_الإلكتروني، "[a-zA-Z0-9._+-]+@[a-zA-Z0-9_.-]+\\.[a-zA-Z0-9]+").هات_الطول() == 0 {
            هذا.الإشعار.النص = نـص("عنوان البريد الإلكتروني غير صالح")؛
            هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
            ارجع؛
        }

        إذا هذا.رمز_كابجا == "" {
            هذا.الإشعار.النص = نـص("يجب التحقق من أنك لست روبوتًا")؛
            هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
            ارجع؛
        }

        عرف جيسون: نـص = نـص.املأ(
            ‏"{\"name\": \"%s\", \"email\": \"%s\", \"title\": \"%s\", \"body\": \"%s\", \"captchatoken\": \"%s\"}"،
            رمّز_إكسمل(الاسم).صوان،
            رمّز_إكسمل(البريد_الإلكتروني).صوان،
            رمّز_إكسمل(العنوان).صوان،
            رمّز_إكسمل(المتن).صوان،
            هذا.رمز_كابجا.صوان
        )؛
        هذا.الإشعار.النص = نـص("")؛
        أرسل_نداء(
            _إرسال_، _المسار_، _ترويسة_صنف_بيانات_نصي_، جيسون، 10000، مغلفة(جسون: جـيسون) {
                إذا جسون.هات_كائن("eventData").هات_صحيح("status") == 200 {
                    هذا.الإشعار.النص = نـص("أُرسلت الرسالة بنجاح")؛
                    هذا.الإشعار.اسم_الفئة = نـص("إشعار_نجاح")؛
                } وإلا {
                    هذا.الإشعار.النص = نـص("حدث خطأ غير متوقع")؛
                    هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
                }
            }
        )؛
    }

    عملية (هذا: مـشهد_أيقوني).قد_تغير_العرض(عرض: صـحيح) حدد_مؤشر {
        هذا.المشهد.الطراز.العرض = نـص.املأ("calc(%ipx - 30pt)"، عرض)؛
    }

    عملية هذا_الصنف (): سـندنا[مـشهد_الاتصال] {
        أرجع سـندنا[مـشهد_الاتصال]().{ احجز()~هيئ() }؛
    }
}
